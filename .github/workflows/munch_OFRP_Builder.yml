name: ðŸ¦Š OrangeFox for munch - æž„å»º

on:
  workflow_dispatch:
    inputs:
      # åŸºç¡€é…ç½® (5ä¸ª)
      MANIFEST_BRANCH:
        description: 'OrangeFoxæºç åˆ†æ”¯'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 14.1
      DEVICE_TREE:
        description: 'è®¾å¤‡æ ‘ä»“åº“'
        required: true
        default: 'https://github.com/Pranav-Talmale/recovery_device_xiaomi_munch#fox_12.1'
      KERNEL_SOURCE:
        description: 'å†…æ ¸æºç  (æ ¼å¼: URL#åˆ†æ”¯)'
        required: true
        default: 'https://github.com/liyafe1997/kernel_xiaomi_sm8250_mod#android15-lineage22-mod'
      DEVICE_NAME:
        description: 'è®¾å¤‡ä»£å·'
        required: true
        default: 'munch'
      BUILD_TARGET:
        description: 'æž„å»ºç›®æ ‡'
        required: true
        default: 'boot'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      KERNEL_NAME:
        description: 'å†…æ ¸ç‰ˆæœ¬åŽç¼€ (å¦‚: -Custom)'
        required: false
        default: '-Nijika-v2.0-SukiSU'
      MAGISK_VERSION:
        description: 'Magiskç‰ˆæœ¬'
        required: true
        default: 'MagiskAlpha'
        type: choice
        options:
        - Magisk
        - MagiskAlpha
        - MagiskDelta
      # é«˜çº§é…ç½® (1ä¸ª)
      OF_MAINTAINER:
        description: 'maintainer'
        required: true
        default: 'Grass2000'

env:
  DEVICE_PATH: device/xiaomi/${{ inputs.DEVICE_NAME }}
  KERNEL_DIR: kernel/xiaomi/${{ inputs.DEVICE_NAME }}
  CLANG_DIR: prebuilts/clang/host/linux-x86/clang-13.0.0

jobs:
  build:
    name: ðŸ—ï¸ æž„å»º OrangeFox by ${{ github.actor }}
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ›’ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
              
    - name: ðŸ§¹ æ¸…ç†ç©ºé—´
      uses: rokibhasansagar/slimhub_actions@main

    - name: ðŸ’¾ è®¾ç½®äº¤æ¢ç©ºé—´
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24
      
    - name: ðŸ› ï¸ æž„å»ºçŽ¯å¢ƒ
      run: |
        sudo apt update
        sudo apt install -y aria2 git-lfs
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
        cd scripts
        sudo bash setup/android_build_env.sh
      
    - name: ðŸ“œ å»ºç«‹æ¸…å•
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
    
    - name: ðŸ“¥ å…‹éš†æºç 
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        # è§£æžè®¾å¤‡æ ‘
        DEVICE_TREE="${{ inputs.DEVICE_TREE }}"
        DEVICE_TREE_URL=${DEVICE_TREE%#*}
        DEVICE_TREE_BRANCH=${DEVICE_TREE#*#}
        git clone ${DEVICE_TREE_URL} -b ${DEVICE_TREE_BRANCH} ${DEVICE_PATH}

        # è§£æžå†…æ ¸
        KERNEL_SOURCE="${{ inputs.KERNEL_SOURCE }}"
        KERNEL_URL=${KERNEL_SOURCE%#*}
        KERNEL_BRANCH=${KERNEL_SOURCE#*#}
        git clone ${KERNEL_URL} -b ${KERNEL_BRANCH} --depth=1 ${KERNEL_DIR}

        # å…‹éš†ç¼–è¯‘å·¥å…·é“¾
        git clone https://github.com/kdrag0n/proton-clang --depth=1 ${CLANG_DIR}

        cd ${DEVICE_PATH}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: âœï¸ ä¿®æ”¹æºç 
      if: inputs.KERNEL_NAME != ''
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${DEVICE_PATH}
        if [ -f BoardConfig.mk ]; then
          if grep -q "TARGET_KERNEL_VERSION" BoardConfig.mk; then
            sed -i "s|TARGET_KERNEL_VERSION := .*|TARGET_KERNEL_VERSION := ${{ inputs.KERNEL_NAME }}|" BoardConfig.mk
          else
            echo -e "\nTARGET_KERNEL_VERSION := ${{ inputs.KERNEL_NAME }}" >> BoardConfig.mk
          fi
          echo "Set TARGET_KERNEL_VERSION to ${{ inputs.KERNEL_NAME }}"
        else
          echo "BoardConfig.mk not found!"
        fi
    
    - name: âš¡ æ›´æ–° OrangeFox çš„å†…ç½® Magisk
      run: |
        git clone https://github.com/ymdzq/twrp_prebuilt ~/twrp_prebuilt
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${DEVICE_PATH}
        if ! grep -q 'FOX_USE_SPECIFIC_MAGISK_ZIP' vendorsetup.sh; then 
          echo -e '\nexport FOX_USE_SPECIFIC_MAGISK_ZIP=~/twrp_prebuilt/Magisk/${{ inputs.MAGISK_VERSION }}.apk' >> vendorsetup.sh
        else 
          sed -i "s|export FOX_USE_SPECIFIC_MAGISK_ZIP=.*|export FOX_USE_SPECIFIC_MAGISK_ZIP=~/twrp_prebuilt/Magisk/${{ inputs.MAGISK_VERSION }}.apk|" vendorsetup.sh
        fi
    
    - name: ðŸ”¨ æž„å»º OrangeFox
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export OF_MAINTAINER="${{ inputs.OF_MAINTAINER }}"
        export FOX_USE_NANO_EDITOR=1
        export LC_ALL="C"
        export FOX_BUILD_DEVICE=munch
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        make clean
        mka adbd ${{ inputs.BUILD_TARGET }}image
    
    - name: ðŸ·ï¸ è®¾ç½®å‘å¸ƒå±žæ€§
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "RELEASE_NAME=OrangeFox-${{ inputs.MANIFEST_BRANCH }}-${{ env.BUILD_DATE }}" >> $GITHUB_ENV
    
    - name: ðŸš€ ä¸Šä¼ è‡³ Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox-*.zip
          ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox-*.img
        name: ${{ env.RELEASE_NAME }}
        tag_name: build-${{ env.BUILD_DATE }}
        body: |
          ### OrangeFox Recovery for ${{ inputs.DEVICE_NAME }}
          **Build Date:** ${{ env.BUILD_DATE }}  
          **Manifest Branch:** ${{ inputs.MANIFEST_BRANCH }}  
          **Device Tree:** [${{ inputs.DEVICE_TREE }}](${inputs.DEVICE_TREE%#*})  
          **Kernel:** [${{ inputs.KERNEL_SOURCE }}](${inputs.KERNEL_SOURCE%#*})  
          **Maintainer:** ${{ inputs.OF_MAINTAINER }}
